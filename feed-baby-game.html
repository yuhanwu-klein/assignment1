<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feed the Baby</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #title {
            color: white;
            font-size: 3em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            animation: bounce 2s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        #game-container {
            position: relative;
            width: 800px;
            height: 600px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            overflow: hidden;
        }

        #webcam-feed {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.2;
            filter: blur(3px);
        }

        #baby-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        #baby-image {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid white;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            transition: transform 0.3s ease, filter 0.3s ease;
        }

        #baby-image.eating {
            transform: scale(1.05);
            filter: brightness(1.2);
        }

        #baby-image.happy {
            transform: scale(1.1);
            filter: brightness(1.3) saturate(1.5);
        }

        #mouth-overlay {
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4em;
            transition: all 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }

        #mouth-overlay.show {
            opacity: 1;
        }

        #food-particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 15;
        }

        .food-particle {
            position: absolute;
            font-size: 2em;
            animation: fall 1.5s ease-in forwards;
            opacity: 0;
        }

        @keyframes fall {
            0% {
                opacity: 1;
                transform: translateY(-50px) rotate(0deg);
            }
            100% {
                opacity: 0;
                transform: translateY(200px) rotate(360deg);
            }
        }

        #feedback {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 2.5em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 20;
        }

        #feedback.show {
            opacity: 1;
        }

        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 20;
        }

        button {
            padding: 12px 24px;
            font-size: 1em;
            border: none;
            border-radius: 25px;
            background: white;
            color: #667eea;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button.active {
            background: #4CAF50;
            color: white;
        }

        #status {
            position: absolute;
            top: 10px;
            right: 10px;
            color: white;
            font-size: 0.9em;
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 10px;
            z-index: 20;
        }

        .status-indicator {
            margin: 5px 0;
        }

        .status-indicator.active {
            color: #4CAF50;
            font-weight: bold;
        }

        #instructions {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            text-align: center;
            font-size: 1.1em;
            background: rgba(0,0,0,0.4);
            padding: 15px 25px;
            border-radius: 15px;
            z-index: 20;
        }

        #brightness-meter {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 150px;
            height: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            overflow: hidden;
            z-index: 20;
        }

        #brightness-bar {
            height: 100%;
            background: linear-gradient(to right, #333, #fff);
            width: 0%;
            transition: width 0.1s ease;
        }

        #volume-meter {
            position: absolute;
            top: 40px;
            left: 10px;
            width: 150px;
            height: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            overflow: hidden;
            z-index: 20;
        }

        #volume-bar {
            height: 100%;
            background: linear-gradient(to right, #4CAF50, #FF5722);
            width: 0%;
            transition: width 0.1s ease;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h1 id="title">üçº Feed the Baby üë∂</h1>

    <div id="game-container">
        <video id="webcam-feed" autoplay playsinline muted></video>
        <canvas id="detection-canvas" class="hidden"></canvas>

        <div id="brightness-meter" title="Brightness Detection">
            <div id="brightness-bar"></div>
        </div>

        <div id="volume-meter" title="Sound Level">
            <div id="volume-bar"></div>
        </div>

        <div id="status">
            <div class="status-indicator" id="mic-status">üé§ Mic: OFF</div>
            <div class="status-indicator" id="cam-status">üì∑ Cam: OFF</div>
        </div>

        <div id="baby-container">
            <img id="baby-image" src="baby.jpg" alt="Baby">
            <div id="mouth-overlay">üòã</div>
        </div>

        <div id="food-particles"></div>

        <div id="feedback"></div>

        <div id="instructions">
            üó£Ô∏è Say "Ahhh" to feed the baby!<br>
            ü§ö Show white tissue to the camera to clean!
        </div>

        <div id="controls">
            <button id="start-btn">Start Game</button>
            <button id="stop-btn" class="hidden">Stop Game</button>
        </div>
    </div>

    <script>
        // Game state
        let isPlaying = false;
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let webcamStream = null;
        let animationFrame = null;

        // DOM elements
        const babyImage = document.getElementById('baby-image');
        const mouthOverlay = document.getElementById('mouth-overlay');
        const feedback = document.getElementById('feedback');
        const foodParticles = document.getElementById('food-particles');
        const webcamFeed = document.getElementById('webcam-feed');
        const detectionCanvas = document.getElementById('detection-canvas');
        const brightnessBar = document.getElementById('brightness-bar');
        const volumeBar = document.getElementById('volume-bar');
        const micStatus = document.getElementById('mic-status');
        const camStatus = document.getElementById('cam-status');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');

        // Thresholds
        const VOLUME_THRESHOLD = 30; // Sound level to trigger eating (0-100)
        const BRIGHTNESS_THRESHOLD = 70; // White level to trigger cleaning (0-100)
        const EATING_DURATION = 1500; // How long eating state lasts (ms)
        const HAPPY_DURATION = 2000; // How long happy state lasts (ms)

        // State tracking
        let currentState = 'neutral'; // neutral, eating, happy
        let stateTimeout = null;
        let lastEatTime = 0;
        let lastCleanTime = 0;

        // Initialize webcam
        async function initWebcam() {
            try {
                webcamStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480 },
                    audio: false
                });
                webcamFeed.srcObject = webcamStream;

                detectionCanvas.width = 640;
                detectionCanvas.height = 480;

                camStatus.textContent = 'üì∑ Cam: ON';
                camStatus.classList.add('active');

                return true;
            } catch (error) {
                console.error('Error accessing webcam:', error);
                alert('Could not access webcam. Please allow camera permissions.');
                return false;
            }
        }

        // Initialize microphone
        async function initMicrophone() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;

                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);

                micStatus.textContent = 'üé§ Mic: ON';
                micStatus.classList.add('active');

                return true;
            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('Could not access microphone. Please allow microphone permissions.');
                return false;
            }
        }

        // Detect sound level
        function detectSound() {
            if (!analyser) return 0;

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);

            // Calculate average volume
            let sum = 0;
            for (let i = 0; i < bufferLength; i++) {
                sum += dataArray[i];
            }
            const average = sum / bufferLength;

            // Normalize to 0-100
            const volume = (average / 255) * 100;

            // Update volume meter
            volumeBar.style.width = volume + '%';

            return volume;
        }

        // Detect brightness from webcam
        function detectBrightness() {
            if (!webcamFeed.videoWidth) return 0;

            const ctx = detectionCanvas.getContext('2d');
            ctx.drawImage(webcamFeed, 0, 0, detectionCanvas.width, detectionCanvas.height);

            const imageData = ctx.getImageData(0, 0, detectionCanvas.width, detectionCanvas.height);
            const data = imageData.data;

            let totalBrightness = 0;
            const pixelCount = data.length / 4;

            // Sample every 10th pixel for performance
            for (let i = 0; i < data.length; i += 40) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                const brightness = (r + g + b) / 3;
                totalBrightness += brightness;
            }

            const averageBrightness = totalBrightness / (pixelCount / 10);
            const normalizedBrightness = (averageBrightness / 255) * 100;

            // Update brightness meter
            brightnessBar.style.width = normalizedBrightness + '%';

            return normalizedBrightness;
        }

        // Show feedback message
        function showFeedback(message, duration = 1500) {
            feedback.textContent = message;
            feedback.classList.add('show');

            setTimeout(() => {
                feedback.classList.remove('show');
            }, duration);
        }

        // Create food particles
        function createFoodParticles() {
            const foods = ['üçé', 'üçå', 'üçá', 'üçì', 'ü•ï', 'ü•¶', 'üçû', 'ü•õ'];
            const randomFood = foods[Math.floor(Math.random() * foods.length)];

            const particle = document.createElement('div');
            particle.className = 'food-particle';
            particle.textContent = randomFood;
            particle.style.left = (Math.random() * 80 + 10) + '%';
            particle.style.top = '20%';

            foodParticles.appendChild(particle);

            setTimeout(() => {
                particle.remove();
            }, 1500);
        }

        // Change baby state
        function setState(newState) {
            if (stateTimeout) {
                clearTimeout(stateTimeout);
                stateTimeout = null;
            }

            // Remove all state classes
            babyImage.classList.remove('eating', 'happy');
            mouthOverlay.classList.remove('show');

            currentState = newState;

            switch (newState) {
                case 'eating':
                    babyImage.classList.add('eating');
                    mouthOverlay.textContent = 'üòã';
                    mouthOverlay.classList.add('show');
                    showFeedback('Yum yum! üòã');
                    createFoodParticles();

                    stateTimeout = setTimeout(() => {
                        setState('neutral');
                    }, EATING_DURATION);
                    break;

                case 'happy':
                    babyImage.classList.add('happy');
                    mouthOverlay.textContent = 'üòä';
                    mouthOverlay.classList.add('show');
                    showFeedback('Clean again! ‚ú®üòä', 2000);

                    stateTimeout = setTimeout(() => {
                        setState('neutral');
                    }, HAPPY_DURATION);
                    break;

                case 'neutral':
                default:
                    // Already cleared classes above
                    break;
            }
        }

        // Main game loop
        function gameLoop() {
            if (!isPlaying) return;

            const now = Date.now();

            // Detect sound
            const volume = detectSound();
            if (volume > VOLUME_THRESHOLD && currentState === 'neutral' && now - lastEatTime > 2000) {
                lastEatTime = now;
                setState('eating');
            }

            // Detect brightness (white tissue)
            const brightness = detectBrightness();
            if (brightness > BRIGHTNESS_THRESHOLD && currentState !== 'happy' && now - lastCleanTime > 3000) {
                lastCleanTime = now;
                setState('happy');
            }

            animationFrame = requestAnimationFrame(gameLoop);
        }

        // Start game
        async function startGame() {
            if (isPlaying) return;

            const webcamOk = await initWebcam();
            const micOk = await initMicrophone();

            if (!webcamOk || !micOk) {
                stopGame();
                return;
            }

            isPlaying = true;
            startBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');

            gameLoop();
        }

        // Stop game
        function stopGame() {
            isPlaying = false;

            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
                animationFrame = null;
            }

            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }

            if (webcamStream) {
                webcamStream.getTracks().forEach(track => track.stop());
                webcamStream = null;
            }

            micStatus.textContent = 'üé§ Mic: OFF';
            micStatus.classList.remove('active');
            camStatus.textContent = 'üì∑ Cam: OFF';
            camStatus.classList.remove('active');

            setState('neutral');

            startBtn.classList.remove('hidden');
            stopBtn.classList.add('hidden');

            volumeBar.style.width = '0%';
            brightnessBar.style.width = '0%';
        }

        // Event listeners
        startBtn.addEventListener('click', startGame);
        stopBtn.addEventListener('click', stopGame);

        // Cleanup on page unload
        window.addEventListener('beforeunload', stopGame);
    </script>
</body>
</html>
